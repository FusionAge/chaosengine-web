//VARIABLE
set_comp0 = '<svg xmlns="http://www.w3.org/2000/svg" id="sv" width="80" height="80" viewBox="0 0 80 80"> <g> <path id="0" fill="#76ff03" d="M40, 0 A40,40 0 0 1 40,0 L40,13 A27,27 0 0 0 40,13 Z"></path> <path id="1" fill="#212121" d="M40, 0 A40,40 0 1 1 39.99301868302749,6.092348385777768e-7 L39.99528761104356,13.000000411233515 A27,27 0 1 0 40,13 Z"></path> <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="white" stroke="#FFFFFF" font-size="1.8em">0/6</text> </g> </svg>'
set_comp1 = '<svg xmlns="http://www.w3.org/2000/svg" id="sv" width="80" height="80" viewBox="0 0 80 80"> <g> <path id="0" fill="#76ff03" d="M40, 0 A40,40 0 0 1 75.05169542955542,20.728813022709694 L63.65989441494991,26.991948790329044 A27,27 0 0 0 40,13 Z"></path> <path id="1" fill="#212121" d="M75.05169542955542, 20.728813022709694 A40,40 0 1 1 39.99301868302749,6.092348385777768e-7 L39.99528761104356,13.000000411233515 A27,27 0 1 0 63.65989441494991,26.991948790329044 Z"></path> <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="white" stroke="#FFFFFF" font-size="1.8em">1/6</text> </g> </svg>'
set_comp2 = '<svg xmlns="http://www.w3.org/2000/svg" id="sv" width="80" height="80" viewBox="0 0 80 80"> <g> <path id="0" fill="#76ff03" d="M40, 0 A40,40 0 0 1 73.77438882469973,61.43106762431583 L62.797712456672315,54.46597064641318 A27,27 0 0 0 40,13 Z"></path> <path id="1" fill="#212121" d="M73.77438882469973, 61.43106762431583 A40,40 0 1 1 39.99301868302749,6.092348385777768e-7 L39.99528761104356,13.000000411233515 A27,27 0 1 0 62.797712456672315,54.46597064641318 Z"></path> <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="white" stroke="#FFFFFF" font-size="1.8em">2/6</text> </g> </svg>'
set_comp3 = '<svg xmlns="http://www.w3.org/2000/svg" id="sv" width="80" height="80" viewBox="0 0 80 80"> <g> <path id="0" fill="#76ff03" d="M40, 0 A40,40 0 0 1 40.003490658499544,79.9999998476913 L40.00235619448719,66.99999989719163 A27,27 0 0 0 40,13 Z"></path> <path id="1" fill="#212121" d="M40.003490658499544, 79.9999998476913 A40,40 0 0 1 39.99301868302749,6.092348385777768e-7 L39.99528761104356,13.000000411233515 A27,27 0 0 0 40.00235619448719,66.99999989719163 Z"></path> <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="white" stroke="#FFFFFF" font-size="1.8em">3/6</text> </g> </svg>'
set_comp4 = '<svg xmlns="http://www.w3.org/2000/svg" id="sv" width="80" height="80" viewBox="0 0 80 80"> <g> <path id="0" fill="#76ff03" d="M40, 0 A40,40 0 1 1 4.949986432227,59.27424574137543 L16.341240841753226,53.01011587542841 A27,27 0 1 0 40,13 Z"></path> <path id="1" fill="#212121" d="M4.949986432227, 59.27424574137543 A40,40 0 0 1 39.99301868302749,6.092348385777768e-7 L39.99528761104356,13.000000411233515 A27,27 0 0 0 16.341240841753226,53.01011587542841 Z"></path> <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="white" stroke="#FFFFFF" font-size="1.8em">4/6</text> </g> </svg>'
set_comp5 = '<svg xmlns="http://www.w3.org/2000/svg" id="sv" width="80" height="80" viewBox="0 0 80 80"> <g> <path id="0" fill="#76ff03" d="M40, 0 A40,40 0 1 1 4.944941647694286,20.734930991132124 L16.337835612193643,26.996078419014182 A27,27 0 1 0 40,13 Z"></path> <path id="1" fill="#212121" d="M4.944941647694286, 20.734930991132124 A40,40 0 0 1 39.99301868302749,6.092348385777768e-7 L39.99528761104356,13.000000411233515 A27,27 0 0 0 16.337835612193643,26.996078419014182 Z"></path> <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="white" stroke="#FFFFFF" font-size="1.8em">5/6</text> </g> </svg>'
set_comp6 = '<svg xmlns="http://www.w3.org/2000/svg" id="sv" width="80" height="80" viewBox="0 0 80 80"> <g> <path id="0" fill="#76ff03" d="M40, 0 A40,40 0 1 1 39.99301868302749,6.092348385777768e-7 L39.99528761104356,13.000000411233515 A27,27 0 1 0 40,13 Z"></path> <path id="1" fill="#212121" d="M39.99301868302749, 6.092348385777768e-7 A40,40 0 0 1 39.99301868302749,6.092348385777768e-7 L39.99528761104356,13.000000411233515 A27,27 0 0 0 39.99528761104356,13.000000411233515 Z"></path> <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#76ff03" stroke="#76ff03" font-size="1.8em">6/6</text> </g> </svg>'


//HANDLERS

$('#subNewItem').click(function() {
  // Check for Fuckery
  var filledCount = 0;
  var valid = true;
  $('#frmNewItem input[type=number]').each(function() {
    if ($(this).val() !== '') {
      filledCount++;
      if (!$.isNumeric($(this).val())) {
        valid = false;
      }
    }
  });

  if (filledCount < 2) {
    error_lessthantwoitems()
  } else if (filledCount > 3) {
    error_morethanthreeitems()
  } else if (!valid) {
    error_itemstatsnumbers()
  } else {
    //No Fuckery...let's go.
    function postStats(myid) {
  	$.post('../api/v1/stats/' + myid,
      	{
      		charname: $("#charname").val(),
      		charclass: $("#charclass").val(),
      		myplvl: $("#myplvl").val(),
      		mycr: $("#mycr").val(),
      		myreso: $("#myreso").val(),
      		mydmg: $("#mydmg").val(),
      		mylife: $("#mylife").val()
      	},
      	function(status) {
      		if(status == 'success') {
      			success_status_update();
      		} else {
      			error_status_update();
      			console.log('error')
      		}
      	})
      }
    addSetItem()
  }
});


$('#ni_setid').on('change', function() {
    console.log('Changed! Sending:' +this.value)
    getSetItems(this.value)
});

//FUNCTIONS
//STATS
function getStats(myid) {
	$.get('../api/v1/stats/' + myid, function(data,status) {
		if(!data) {
			error_no_id()
		} else {
			$('#charname').val(data.charname);
			$("#charclass").val(data.classid);
			$("#myplvl").val(data.plvl);
			$("#mycr").val(data.cr);
			$("#myreso").val(data.reso);
			$("#mydmg").val(data.dmg);
			$("#mylife").val(data.life);
			$("#clanname").val(data.guildname + " (" + data.guildserver + ")")
		}
	})
}

function postStats(myid) {
	$.post('../api/v1/stats/' + myid,
	{
		charname: $("#charname").val(),
		charclass: $("#charclass").val(),
		myplvl: $("#myplvl").val(),
		mycr: $("#mycr").val(),
		myreso: $("#myreso").val(),
		mydmg: $("#mydmg").val(),
		mylife: $("#mylife").val()
	},
	function(status) {
		if(status == 'success') {
			success_status_update();
		} else {
			error_status_update();
			console.log('error')
		}
	})
}

//SETS
function getSets() {
	$.get('../api/v1/sets/', function(data,status) {
		if(!data) {
			error_no_id()
		} else {
			data.forEach(function(item){
				var text = item.setname;
				var value = item.setid;
				var option = $('<option></option>').text(text).val(value);
				$("#ni_setid").append(option)
			})
			$("#ni_setid").trigger('change')
		}
	})
}

//SETITEMS
function getSetItems(setid) {
	$.get('../api/v1/setitems/' + setid, function(data,status) {
		if(!data) {
			error_no_id()
		} else {
      $("#ni_slotid").empty()
			data.forEach(function(item) {
        var text = "[" + item.slotname + "] " + item.setitemname;
        var value = item.setitemid
        var option = $('<option></option>').text(text).val(value);
				$("#ni_slotid").append(option)
      })
		}
	})
}

function addSetItem() {
  $("#modalNewItem").modal('hide');
  $.post('../api/v1/equipment/' + myid,
    {
      setitemid: $("#ni_slotid").val(),
      strint:   $("#ni_strint").val().length > 0 ? $("#ni_strint").val() : 0,
      vit:      $("#ni_vit").val().length > 0 ? $("#ni_vit").val() : 0,
      will:     $("#ni_will").val().length > 0 ? $("#ni_will").val() : 0,
      fort:     $("#ni_fort").val().length > 0 ? $("#ni_fort").val() : 0,
      isequipped: 0         
    },
    function(status) {
      if(status=='success') {
        $('#inventory').DataTable().ajax.reload();
        getWantedSets(myid);
        success_status_add();
      } else {
        error_status_add();
        console.log('Error adding item to equipment')
      }
    }
  )
}

function equipSetItem(equipmentid) {
  $.post('../api/v1/equip/' + myid + '/' + equipmentid,
    function(status) {
      if(status=='success') {
        $('#inventory').DataTable().ajax.reload();
        $('#equippedsets').DataTable().ajax.reload();
        success_status_add();
      } else {
        error_status_add();
        console.log('Error Equipping an item')
      }
    }
  )
}



function delSetItem(setitemid) {
  $.ajax({
    url: '../api/v1/equipment/' + myid + '/' + setitemid,
    type: 'DELETE',
    success: function(result) {
       success_item_delete()
       $('#inventory').DataTable().ajax.reload();
       $('#equippedsets').DataTable().ajax.reload();
       getUnwantedSets()
      }
    });
}
			

function getWantedSets() {
  $.get('../api/v1/wantedsets/' + myid, function(data,status) {
		if(!data) {
			error_no_id()
		} else {
      $("#myWantedSetsCol h5").siblings().remove();
      data.forEach(function(item){
        $("#myWantedSetsCol").append(`
            <div class="card radius-10 setitemcard">
            	<div class="card-body">
                <button type="button" class="btn-close float-end" aria-label="Close" onclick="delWantedSets(`+item.setid+`);"></button>
            		<h6 class="card-title">` + item.setname + `</h6>
            		<div class="container">
            			<div class="row g-0">
            			  <div class="col-4 p-2">` + window["set_comp" + item.slots_filled] + `</div>
            			  <div class="col-8">
            				<b>Need to Farm:</b>
            				<ul class="list-group">` + item.missing_setitems + `</ul>
            			  </div>
            			</div>
            		</div>
            		<b class="my-1 text-white">Total Items: ` + item.setitems_in_equipment + `</b>
            	</div>
            </div>	
        `)
      })
		}
	})
}

function updWantedSets() {
  $("#modalAddWanted").modal('hide');
  $.post('/api/v1/wantedsets/' + myid + '/' + $('#ws_setid').val(),
    function(status) {
      if(status=='success') {
        getUnwantedSets();
        getWantedSets();
        success_status_add();
      } else {
        error_status_add();
        console.log('Error Equipping an item')
      }
    }
  )
}

function delWantedSets(setid) {
  $.ajax({
    url: '../api/v1/wantedsets/' + myid + '/' + setid,
    type: 'DELETE',
    success: function(result) {
       success_item_delete()
       getWantedSets()
      }
    });
}

function getUnwantedSets() {
  $.get('../api/v1/unwantedsets/' +myid, function(data,status) {
		if(!data) {
			error_no_id()
		} else {
      $("#ws_setid option").remove(); 
			data.forEach(function(item){
				var text = item.setname;
				var value = item.setid;
				var option = $('<option></option>').text(text).val(value);
				$("#ws_setid").append(option)
			})
			$("#ws_setid").trigger('change')
		}
	})
}


//ENDREGION


//Notifications (Make this a constructor!)
function error_no_id() {
	Lobibox.notify('error', {
		pauseDelayOnHover: true,
		rounted: true,
		continueDelayOnInactiveTab: false,
		position: 'top center',
		icon: 'bx bx-x-circle',
		msg: 'ERROR! This link is invalid, please run <b>/tool</b> again within discord to generate a new link.'
	});
}

function success_status_update() {
	Lobibox.notify('success', {
		sound: false,
		pauseDelayOnHover: true,
		rounted: true,
		continueDelayOnInactiveTab: false,
		position: 'top center',
		icon: 'bx bx-x-circle',
		msg: 'Information updated successfully!'
	});
}

function success_status_add() {
	Lobibox.notify('success', {
		sound: false,
		pauseDelayOnHover: true,
		rounted: true,
		continueDelayOnInactiveTab: false,
		position: 'top center',
		icon: 'bx bx-x-circle',
		msg: 'Information added successfully!'
	});
}

function error_status_add() {
	Lobibox.notify('error', {
		sound: false,
		pauseDelayOnHover: true,
		rounted: true,
		continueDelayOnInactiveTab: false,
		position: 'top center',
		icon: 'bx bx-x-circle',
		msg: 'ERROR! Something went wrong adding that item. Try again later.'
	});
}

function error_status_update() {
	Lobibox.notify('error', {
		sound: false,
		pauseDelayOnHover: true,
		rounted: true,
		continueDelayOnInactiveTab: false,
		position: 'top center',
		icon: 'bx bx-x-circle',
		msg: 'ERROR! Something went wrong updating your info. Try again later.'
	});
}

function error_lessthantwoitems() {
  Lobibox.notify('error', {
		sound: false,
		pauseDelayOnHover: true,
		rounted: true,
		continueDelayOnInactiveTab: false,
		position: 'top center',
		icon: 'bx bx-x-circle',
		msg: 'ERROR! You need at least TWO stats for that item, and only numbers allowed!)'
	});
}

function error_morethanthreeitems() {
  Lobibox.notify('error', {
		sound: false,
		pauseDelayOnHover: true,
		rounted: true,
		continueDelayOnInactiveTab: false,
		position: 'top center',
		icon: 'bx bx-x-circle',
		msg: 'ERROR! You can only have a max of THREE stats for that item, and only numbers allowed!'
	});
}

function error_itemstatsnumbers() {
  Lobibox.notify('error', {
		sound: false,
		pauseDelayOnHover: true,
		rounted: true,
		continueDelayOnInactiveTab: false,
		position: 'top center',
		icon: 'bx bx-x-circle',
		msg: 'ERROR! Only numbers allowed!'
	});
}

function success_item_delete() {
  Lobibox.notify('success', {
		sound: false,
		pauseDelayOnHover: true,
		rounted: true,
		continueDelayOnInactiveTab: false,
		position: 'top center',
		icon: 'bx bx-x-circle',
		msg: 'Item deleted successfully!'
	});
}
